@if (state) {
  @if ((state.emptyFeedback?.isFeatured) && (treeItems != null && treeItems.length === 0)) {
    <smz-data-info
      [image]="state.emptyFeedback.image"
      [message]="state.emptyFeedback.message"
      [callbackInfo]="state.emptyFeedback.extraInfo"
      [callbackLabel]="state.emptyFeedback.actionButton?.label"
      (clicked)="state.emptyFeedback.actionButton?.callback($event)">
      <ng-template pTemplate="actions">
        <ng-container *ngTemplateOutlet="emptyActionsTemplate; context: { $implicit: {} }"></ng-container>
      </ng-template>
    </smz-data-info>
  } @else {
    @if (treeItems != null) {
      <p-contextMenu #cm [model]="menuItems" [appendTo]="appendTo" [styleClass]="menuItems == null || menuItems?.length === 0 ? 'invisible-important' : ''"></p-contextMenu>
      <p-menu #rowMenu [model]="menuItems" [popup]="true" appendTo="body" />
      <p-tree #dt [value]="treeItems"
        scrollHeight="flex"
        [contextMenu]="state.menu.behavior === 'context-menu' ? cm : null"
        [selectionMode]="state.selection.mode"
        [(selection)]="primeSelection"
        layout="vertical"
        [style]="inlineStyle"
        [styleClass]="styleClass"
        [propagateSelectionUp]="state.selection.propagateUp"
        [propagateSelectionDown]="state.selection.propagateDown"
        [loading]="state.loading.isLoading"
        [loadingIcon]="state.loading.icon"
        [filter]="false"
        [filterMode]="state.filter.mode"
        [filterPlaceholder]="state.filter.textPlaceholder"
        [draggableNodes]="state.dragAndDrop.draggable"
        [droppableNodes]="state.dragAndDrop.droppable"
        [validateDrop]="state.dragAndDrop.validateDrop"
        (onNodeContextMenuSelect)="onContextMenuOpen($event)"
        (onNodeSelect)="onSelected($event)"
        (onNodeUnselect)="onUnselected($event)"
        (onNodeExpand)="onExpanded($event)"
        (onNodeCollapse)="onCollapsed($event)"
        (onNodeDrop)="onDropped($event)"
        (onFilter)="onFiltered($event)">
        @if (state.header.isVisible) {
          <ng-template pTemplate="header">
            @if (state.header.toolbar; as toolbar) {
              @if (headerTemplate != null) {
                <div class="grid grid-nogutter items-center w-full justify-start">
                  <ng-container *ngTemplateOutlet="headerTemplate; context: { $implicit: dt }"></ng-container>
                </div>
              }
              <div class="grid grid-nogutter justify-start items-center mb-2 gap-2">
                @if (state.header.title != null) {
                  <h3 class="m-2 col">{{state.header.title}}</h3>
                }
                <div class="grid grid-nogutter justify-start items-center gap-2">
                  @for (button of state.header.toolbar.items; track button; let i = $index) {
                    <button
                      pButton
                      pRipple
                      type="button"
                      [ngClass]="{ 'p-button-text': toolbar.buttonType.endsWith('borderless'), 'p-button-outlined': toolbar.buttonType.endsWith('outlined'), 'p-button-rounded': toolbar.buttonType.startsWith('rounded'), 'p-button-secondary': button.color === 'secondary', 'p-button-success': button.color === 'success', 'p-button-info': button.color === 'info', 'p-button-warning': button.color === 'warning', 'p-button-help': button.color === 'help', 'p-button-danger': button.color === 'danger' }"
                      [label]="button.label"
                      [icon]="button.icon"
                      (click)="onToolbarButtonClick($event, button, treeItems)"
                      [pTooltip]="button.tooltip">
                    </button>
                  }
                  @if (toolbar.nodeExpandButtons.isVisible === true) {
                    <button
                      pButton
                      pRipple
                      type="button"
                      [ngClass]="{ 'p-button-text': toolbar.buttonType.endsWith('borderless'), 'p-button-outlined': toolbar.buttonType.endsWith('outlined'), 'p-button-rounded': toolbar.buttonType.startsWith('rounded'), 'p-button-secondary': true }"
                      [label]="toolbar.nodeExpandButtons.expandLabel"
                      icon="fa-solid fa-angle-down"
                      (click)="expandNode()"
                      [pTooltip]="selection != null ? toolbar.nodeExpandButtons.expandTooltip : toolbar.nodeExpandButtons.disabledTooltip"
                      [disabled]="selection == null">
                    </button>
                  }
                  @if (toolbar.nodeExpandButtons.isVisible === true) {
                    <button
                      pButton
                      pRipple
                      type="button"
                      [ngClass]="{ 'p-button-text': toolbar.buttonType.endsWith('borderless'), 'p-button-outlined': toolbar.buttonType.endsWith('outlined'), 'p-button-rounded': toolbar.buttonType.startsWith('rounded'), 'p-button-secondary': true }"
                      [label]="toolbar.nodeExpandButtons.collapseLabel"
                      icon="fa-solid fa-angle-up"
                      (click)="collapseNode()"
                      [pTooltip]="selection != null ? toolbar.nodeExpandButtons.collapseTooltip : toolbar.nodeExpandButtons.disabledTooltip"
                      [disabled]="selection == null">
                    </button>
                  }
                  @if (toolbar.treeExpandButtons.isVisible === true) {
                    <button
                      pButton
                      pRipple
                      type="button"
                      [ngClass]="{ 'p-button-text': toolbar.buttonType.endsWith('borderless'), 'p-button-outlined': toolbar.buttonType.endsWith('outlined'), 'p-button-rounded': toolbar.buttonType.startsWith('rounded'), 'p-button-secondary': true }"
                      [label]="toolbar.treeExpandButtons.expandLabel"
                      icon="fa-solid fa-angles-down"
                      (click)="expandAll()"
                      [pTooltip]="">
                    </button>
                  }
                  @if (toolbar.treeExpandButtons.isVisible === true) {
                    <button
                      pButton
                      pRipple
                      type="button"
                      [ngClass]="{ 'p-button-text': toolbar.buttonType.endsWith('borderless'), 'p-button-outlined': toolbar.buttonType.endsWith('outlined'), 'p-button-rounded': toolbar.buttonType.startsWith('rounded'), 'p-button-secondary': true }"
                      [label]="toolbar.treeExpandButtons.collapseLabel"
                      icon="fa-solid fa-angles-up"
                      (click)="collapseAll()"
                      [pTooltip]="">
                    </button>
                  }
                  @if (actionsTemplate != null) {
                    <div class="grid grid-nogutter items-center justify-start">
                      <ng-container *ngTemplateOutlet="actionsTemplate; context: { $implicit: dt }"></ng-container>
                    </div>
                  }
                </div>
                @if (state.filter.show) {
                  <p-iconfield class="col-12" [ngClass]="state.filter.styleClass">
                    <p-inputicon styleClass="pi pi-search" />
                    <input #inputGlobal pInputText type="text" (input)="dt._filter(inputGlobal.value)" [placeholder]="state.filter.textPlaceholder" />
                  </p-iconfield>
                }
              </div>
              @if (toolbarTemplate != null) {
                <div class="grid grid-nogutter items-center mt-2"
                  [ngClass]="'justify-' + state.header.toolbar.alignment">
                  <ng-container *ngTemplateOutlet="toolbarTemplate; context: { $implicit: dt }"></ng-container>
                </div>
              }
            }
          </ng-template>
        }
        @if (state.footer.isVisible) {
          <ng-template pTemplate="footer">
            <div class="grid grid-nogutter justify-start items-center">
              <span class="col mr-2">FOOTER</span>
            </div>
          </ng-template>
        }
        @for (content of contentTemplates; track content) {
          <ng-template let-node [pTemplate]="content.type">
            <div class="grid grid-nogutter items-center justify-start gap-2">
              @if (content.template != null) {
                <ng-container *ngTemplateOutlet="content.template; context: { $implicit: node }"></ng-container>
              } @else {
                <div>{{ node.label }}</div>
              }
              @if (state.menu.behavior === 'row-menu') {
                <p-button clickStopPropagation (onClick)="onRowMenuOpen(node, rowMenu, $event)" [icon]="state.menu.rowMenuIcon" [rounded]="true" [text]="true" [severity]="state.menu.rowMenuIconSeverity"/>
              }
            </div>
          </ng-template>
        }
        <ng-template let-node pTemplate="Check">
          <div class="grid grid-nogutter items-center justify-start gap-2">
            <div>{{ node.label }}</div>
            @if (state.menu.behavior === 'row-menu') {
              <p-button clickStopPropagation (onClick)="onRowMenuOpen(node, rowMenu, $event)" [icon]="state.menu.rowMenuIcon" [rounded]="true" [text]="true" [severity]="state.menu.rowMenuIconSeverity"/>
            }
          </div>
        </ng-template>
        <ng-template pTemplate="empty">
          @if (!state.emptyFeedback.isFeatured) {
            <div>{{ state.emptyFeedback.message }}</div>
          }
        </ng-template>
      </p-tree>
    }
  }
} @else {
  @if (emptyStateTemplate != null) {
    <ng-container *ngTemplateOutlet="emptyStateTemplate; context: { $implicit: {} }"></ng-container>
  }
}

